<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>文章列表</title>
    <link rel="stylesheet" href="./libs/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/iconfont.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="./libs/jquery-1.12.4.min.js"></script>
    <script src="./libs/bootstrap/js/bootstrap.min.js"></script>
    <!-- 引入模板引擎js文件 -->
    <script src="./libs/template-web.js"></script>
</head>

<body>
    <div class="container-fluid" id="app">
        <div class="common_title">
            文章类别管理
        </div>
        <div class="container-fluid common_con">
            <cpn></cpn>
        </div>

        <!-- 模态框 -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        <!-- <input type="hidden" name="" v-model="names"> -->
                        <h4 class="modal-title" id="exampleModalLabel">{{names}}{{namess}}</h4>
                    </div>
                    <div class="modal-body">
                        <form id="form">
                            <div class="form-group">
                                <label for="recipient-name" class="control-label">分类名称:</label>
                                <input type="text" v-model="name" class="form-control" id="recipient-name" name="name">
                            </div>
                            <div class="form-group">
                                <label for="message-text" class="control-label">分类别名:</label>
                                <input class="form-control" v-model="slug" id="message-text" name="slug">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default cancel" @click="xin">新增</button>
                        <button type="button" class="btn btn-primary confirm" @click="en">确认</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <template id="cpn">
        <table class="table table-striped table-bordered table-hover mp20 category_table">
            <thead>
                <tr>
                    <th>名称</th>
                    <th>Slug</th>
                    <th class="text-center" width="100">操作</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(item, index) in list" :key="index">
                    <td>{{item.name}}</td>
                    <td>{{item.slug}}</td>
                    <td class="text-center">
                        <a href="javascript:;" data-target="#myModal" data-toggle="modal" class=" btn btn-info btn-xs"
                            @click="eclick(item.id,item.name,item.slug)">编辑</a>
                        <a href="javascript:;" class="btn btn-danger btn-xs" @click="dclick(item.id)">删除</a>
                    </td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3" class="text-center">
                        <a href="javascript:;" class="btn btn-success" id="xinzengfenlei" data-toggle="modal"
                            data-target="#myModal" @click="zclick">新增分类</a>
                    </td>
                </tr>
            </tfoot>
        </table>
    </template>
</body>
<script src="./libs/vue.js"></script>
<script src="./libs/http.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    let hub = new Vue();
    let vm = new Vue({
        el: '#app',
        data() {
            return {
                // id:'',
                slug: '',
                name: '',
                // lists: [],
                names: '',
                namess: '',
                id: ''
            }
        },
        methods: {
            // 新增的函数
            async en() {
                $('#myModal').modal('hide');
                // this.lists = {name : this.name,slug : this.slug};

                const params = new URLSearchParams();
                params.append('name', this.name);
                params.append('slug', this.slug);
                let {
                    data: ret
                } = await axios.post(BigNew.category_add, params);
                console.log(ret);
                if (ret.code == 201) {
                    alert(ret.msg);
                    // location.reload();
                    let lists = {
                        name: this.name,
                        slug: this.slug
                    };
                    hub.$emit('a', lists);
                }
            },
            // 编辑的函数
            xin() {
                const params = new URLSearchParams();
                params.append('name', this.name);
                params.append('slug', this.slug);
                params.append('id', this.id);
                axios.post(BigNew.category_edit, params).then(({
                    data: ret
                }) => {
                    console.log(ret);
                    if (ret.code == 200) {
                        alert(ret.msg);
                        location.reload();
                    //     let ands = {
                    //     name: this.name,
                    //     slug: this.slug
                    // };
                    // hub.$emit('b', ands);
                    }
                });
            }
        },
        //监听
        mounted() {
            hub.$on('e', (id, slug, name, a) => {
                console.log(id);
                this.name = name;
                this.names = a;
                this.slug = slug;
                this.id = id;

            });
            hub.$on('s', (b) => {
                this.namess = b;
                console.log(b);
            })
        },
        // 模板
        components: {
            'cpn': {
                template: '#cpn',
                data() {
                    return {
                        list: [],
                        id : ''
                    }
                },
                methods: {
                    //删除的函数
                    async dclick(id) {
                        //1.
                        // $.ajax({
                        //     url: BigNew.category_delete,
                        //     type: 'post',
                        //     dataType: 'json',
                        //     data: {
                        //         id: id
                        //     },
                        //     success: function (backData) {
                        //         if (backData.code == 204) {
                        //             alert('删除成功');
                        //             window.location.reload();
                        //         } else {
                        //             alert(backData.msg);
                        //         };
                        //     }
                        // })
                        //2.
                        // console.log(id);
                        const params = new URLSearchParams();
                        params.append('id', id);
                        let {
                            data: ret
                        } = await axios.post(BigNew.category_delete, params);
                        // console.log(ret.code);
                        if (ret.code == 204) {
                            alert(ret.msg);
                            // location.reload();
                            // 不刷新页面
                            // 只在数组里面删除
                            this.list = this.list.filter((n) => {
                                return n.id != id;
                            });
                        }
                    },
                    zclick() {
                        $('#myModal').on('show.bs.modal');
                        let b = '新增分类';
                        hub.$emit('s', b);
                    },
                    //编辑的函数
                    eclick(id, slug, name) {
                        let a = '编辑分类';
                        this.id = id;
                        hub.$emit('e', id, slug, name, a);
                        $('#myModal').on('show.bs.modal');
                    }


                },
                created() {
                    let config = axios.interceptors.request.use(config => {
                        //为请求头对象，添加token验证的Authorization字段
                        config.headers.Authorization = window.sessionStorage.getItem("token");
                        return config
                    })
                    axios.get(BigNew.category_list, config).then(({
                        data: res
                    }) => {
                        // console.log(res);
                        this.list = res.data
                    })
                },
                mounted() {
                    hub.$on('a', (lists) => {
                        console.log(lists);
                        this.list.unshift(lists);
                    });
                    // hub.$on('b', (ands) => {
                    //     console.log(ands);
                    //     ands = {id:this.id};
                    //     this.list.push(ands);
                    // })
                },
            }
        }
    });
</script>

</html>