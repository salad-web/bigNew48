<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>文章列表</title>
    <link rel="stylesheet" href="./libs/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/iconfont.css">
    <link rel="stylesheet" href="./css/main.css">
    <script src="./libs/jquery-1.12.4.min.js"></script>
    <!-- 引入模板引擎js文件 -->
    <script src="./libs/template-web.js"></script>
    <script src="./libs/bootstrap/js/bootstrap.min.js"></script>
    <script src="./libs/axios.js"></script>
    <script src="./libs/jquery.twbsPagination.js"></script>
    <!-- <script src="./libs/vue-paginate.js"></script> -->

</head>

<body>
    <div class="container-fluid" id="app">
        <div class="common_title">
            文章列表
        </div>
        <div class="container-fluid common_con">
            <div class="row opt_btns">
                <div class="col-xs-6">
                    <cps></cps>
                </div>
                <div class="col-xs-6">
                    <a href="article_release.html" class="btn btn-success btn-sm pull-right" id="release_btn">发表文章</a>
                </div>
            </div>
            <cpn></cpn>


            <!-- 分页模块 -->
            <!-- <div class="row text-center">
                <ul id="#pagination-demo" class="pagination-sm"></ul>
            </div> -->

        </div>


    </div>

    <template id="cps">
        <div>
            <form class="form-inline" v-on:submit.prevent=''>
                <select id="selCategory" name="" class="form-control input-sm" v-model="names">
                    <option value="">所有分类</option>
                    <option v-for="(item, index) in lists" :key="index" :value="item.id">{{item.name}}</option>
                </select>
                <select id="selStatus" name="" class="form-control input-sm" v-model="name">
                    <option value="">所有分类</option>
                    <option :value="items" v-for="(items, index) in status" :key="index">{{items}}</option>
                </select>
                <button id="btnSearch" class="btn btn-default btn-sm" @click="sclick()">筛选</button>
            </form>
        </div>
    </template>

    <template id="cpn">
        <div>
            <table class="table table-striped table-bordered table-hover mp20">
                <thead>
                    <tr>
                        <th>标题</th>
                        <th>作者</th>
                        <th>分类</th>
                        <th class="text-center">发表时间</th>
                        <th class="text-center">状态</th>
                        <th class="text-center" width="100">操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(item, index) in list" :key="index">
                        <td>{{item.title}}</td>
                        <td>{{item.author}}</td>
                        <td>{{item.category}}</td>
                        <td class="text-center">{{item.date}}</td>
                        <td class="text-center">{{item.state}}</td>
                        <td class="text-center">
                            <a class="btn btn-default btn-xs" @click="tclick(item.id)">编辑</a>
                            <a href="javascript:void(0);" class="btn btn-danger btn-xs delete"
                                @click="delclick(item.id)">删除</a>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="row text-center">
                <!-- 分页插件的结构 -->
                <ul ref="reference" id="pagination-demo" class="pagination-sm"></ul>
                <p v-if="b == 0">没有数据</p>
            </div>
        </div>
    </template>
</body>
<script src="./libs/vue.js"></script>
<script src="./libs/http.js"></script>
<script>
    // 首先点击进来 就要发送ajax 请求 获得数据渲染页面 !!!
    //  利用模板 来渲染 
    let hub = new Vue();
    let vm = new Vue({
        el: "#app",
        data() {
            return {}
        },

        created() {


        },
        components: {
            //列表页面的组件
            'cpn': {
                template: '#cpn',
                data() {
                    return {
                        list: [],
                        b: '',
                        c: '',
                        d: '',
                        b: '',
                        page: '',
                        flag : false
                    }
                },
                methods: {
                    // 删除的按钮
                    delclick(id) {
                        console.log(id);

                        // 第一种方法!!!
                        // $.ajax({
                        //     url: BigNew.article_delete,
                        //     type: 'post',
                        //     dataType: 'json',
                        //     data: {
                        //         id: $(this).attr('data-id')
                        //     },
                        //     success: function (backData) {
                        //         if (backData.code == 204) {
                        //             alert('删除成功');
                        //             window.location.reload();
                        //         } else {
                        //             alert(backData.msg);
                        //         }
                        //     }
                        // });

                        // 方法二: 
                        const params = new URLSearchParams();
                        // 传入id
                        params.append('id', id);
                        axios.post(BigNew.article_delete, params).then(({
                            data: ret
                        }) => {
                            if (ret.code == 204) {
                                alert(ret.msg);
                                // location.reload();
                                this.list = this.list.filter((n) => {
                                    return n.id != id;
                                });
                                console.log(this.page);
                                // if (this.b == this.Page - 1 && this.Page != 1) {
                                //     this.Page--;
                                $.ajax({
                                    url: BigNew.article_query,
                                    data: {
                                        type: this.c,
                                        state: this.d,
                                        'page': this.page,
                                        perpage: 8
                                    },
                                    success: (backData) => {
                                        if (backData.code == 200) {
                                            //调用模板引擎核心方法
                                            console.log(backData);
                                            let pages = backData.data.totalPage;
                                            if (pages == this.b - 1 && this.page != 1) {
                                                $.ajax({
                                                    url: BigNew.article_query,
                                                    data: {
                                                        type: this.c,
                                                        state: this.d,
                                                        'page': pages,
                                                        perpage: 8
                                                    },
                                                    success: (backData) => {
                                                        if (backData.code ==
                                                            200) {
                                                            //调用模板引擎核心方法
                                                            // console.log(backData);
                                                            this.list = backData
                                                                .data.data;
                                                        }
                                                    }
                                                });
                                            }else {
                                                this.list = backData.data.data;
                                            }
                                        }
                                    }
                                });
                                // }
                            }
                        })
                    },
                    tclick(id) {
                        // url 传参 
                        location.href = './article_edit.html?id=' + id;
                    }
                },
                created() {
                    // 这里面先空着
                    //这里发送ajax 请求 获取文章的列表!!!
                    //请求在到达服务器之前，先会调用use中的这个回调函数来添加请求头信息
                    // 拦截器
                    let config = axios.interceptors.request.use(config => {
                        //为请求头对象，添加token验证的Authorization字段
                        config.headers.Authorization = window.sessionStorage.getItem("token");
                        return config
                    })
                    // 把令牌带过来 
                    axios.get(BigNew.article_query, config).then((res) => {
                        //{data : res} ES 解构
                        console.log(res);
                        this.list = res.data.data.data;
                        this.b = res.data.data.totalPage;
                    });

                    // 在页面加载的时候 渲染出分页列表!!!  不能行
                    this.$nextTick(() => {
                        $('#pagination-demo').twbsPagination({
                            totalPages: 27, //总页数 这个地方改不了
                            visiblePages: 7,
                            first: '首页',
                            prev: '上一页',
                            next: '下一页',
                            last: '尾页',
                            onPageClick: (event, page) => {
                                this.page = page
                                $.ajax({
                                    url: BigNew.article_query,
                                    data: {
                                        type: this.c,
                                        state: this.d,
                                        'page': page,
                                        perpage: 8
                                    },
                                    success: (backData) => {
                                        if (backData.code == 200) {
                                            //调用模板引擎核心方法
                                            // console.log(backData);
                                            this.list = backData.data.data;
                                        }
                                    }
                                });
                            }
                        })
                    })

                    
                },
                computed: {
                    
                },
                mounted() {
                    //  监听兄弟组件发过来的数据
                    hub.$on('e', (a) => {
                        this.list = a;
                    });
                    // 监听兄弟组件发过来的数据
                    hub.$on('s', (b, c, d) => {
                        this.b = b;
                        this.c = c;
                        this.d = d
                        $('#pagination-demo').twbsPagination("changeTotalPages", this.b, this.page);
                        // 判断数据是否为空!!!
                        // if (this.b == 0) {
                        //     $('#pagination-demo').hide();
                        //     $('#none').show();
                        // } else {
                        //     $('#pagination-demo').show();
                        //     $('#none').none();
                        // }
                    });

                },

            },
            // 删选的组件!
            'cps': {
                template: '#cps',
                data() {
                    return {
                        lists: [],
                        status: ['草稿', '已发布'],
                        name: '',
                        names: '',
                        page: 1
                    }
                },
                methods: {
                    // 筛选按钮
                    sclick() {
                        $.ajax({
                            url: BigNew.article_query,
                            data: {
                                type: this.names,
                                state: this.name,
                                page: this.page,
                                perpage: 8
                            },
                            success: (backData) => {
                                if (backData.code == 200) {
                                    //调用模板引擎核心方法
                                    console.log(backData);
                                    let a = backData.data.data;
                                    let b = backData.data.totalPage;
                                    let c = this.names;
                                    let d = this.name;
                                    // 组件之间的传参
                                    hub.$emit('e', a);
                                    hub.$emit('s', b, c, d);
                                }
                            }
                        });
                    }
                },
                mounted() {},
                created() {
                    // 这里面先空着
                    //这里发送ajax 请求 获取文章的列表!!!
                    //请求在到达服务器之前，先会调用use中的这个回调函数来添加请求头信息
                    // 拦截器
                    let config = axios.interceptors.request.use(config => {
                        //为请求头对象，添加token验证的Authorization字段
                        config.headers.Authorization = window.sessionStorage.getItem("token");
                        return config
                    })
                    // 把令牌带过来 
                    axios.get(BigNew.category_list, config).then(({
                        data: res
                    }) => {
                        //{data : res} ES 解构
                        console.log(res);
                        this.lists = res.data;
                    });
                },
            }
        },
    });
</script>

</html>